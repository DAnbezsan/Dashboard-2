import React, { useState, useEffect } from 'react';
import { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Trophy, Users, Gift, TrendingUp, Calendar, Phone, RefreshCw, AlertCircle } from 'lucide-react';

export default function RoletaKPIDashboard() {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [dateRange, setDateRange] = useState('all');
  const [lastUpdate, setLastUpdate] = useState(null);
  
  // COLE AQUI A URL DO SEU GOOGLE APPS SCRIPT
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIjpHdsFx0TyHRs8YDe7fZlJ0l88SPQRklLu2QTMquIeHvvMuIr01ZRY-8GQi7yzXx/exec";

  const fetchData = async () => {
    setLoading(true);
    setError(null);
    
    try {
      // Check if URL is configured
      if (SCRIPT_URL === "https://script.google.com/macros/s/AKfycbxIjpHdsFx0TyHRs8YDe7fZlJ0l88SPQRklLu2QTMquIeHvvMuIr01ZRY-8GQi7yzXx/exec") {
        // Use mock data for demo
        const mockData = generateMockData();
        setData(mockData);
        setLastUpdate(new Date());
        setLoading(false);
        return;
      }

      const response = await fetch(SCRIPT_URL);
      const result = await response.json();
      
      if (result.success) {
        setData(result.data || []);
        setLastUpdate(new Date());
      } else {
        setError(result.error || 'Erro ao carregar dados');
      }
    } catch (err) {
      setError('Erro de conex√£o: ' + err.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  const filteredData = filterByDateRange(data, dateRange);
  const kpis = calculateKPIs(filteredData);

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white p-4">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8 flex justify-between items-start">
          <div>
            <h1 className="text-4xl font-bold text-yellow-400 mb-2 flex items-center gap-3">
              üé∞ Dashboard - Roleta Premiada
            </h1>
            <p className="text-gray-400">Acompanhe os KPIs da sua promo√ß√£o em tempo real</p>
            {lastUpdate && (
              <p className="text-xs text-gray-500 mt-1">
                √öltima atualiza√ß√£o: {lastUpdate.toLocaleString('pt-BR')}
              </p>
            )}
          </div>
          <button
            onClick={fetchData}
            disabled={loading}
            className="flex items-center gap-2 px-4 py-2 bg-yellow-500 text-black rounded-lg hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <RefreshCw className={loading ? 'animate-spin' : ''} size={18} />
            Atualizar
          </button>
        </div>

        {/* Error Alert */}
        {error && (
          <div className="mb-6 p-4 bg-red-900 border border-red-700 rounded-lg flex items-start gap-3">
            <AlertCircle className="text-red-400 flex-shrink-0 mt-0.5" />
            <div>
              <p className="font-bold text-red-200">Erro ao carregar dados</p>
              <p className="text-sm text-red-300">{error}</p>
              <p className="text-xs text-red-400 mt-2">
                Verifique se a URL do Apps Script est√° configurada corretamente
              </p>
            </div>
          </div>
        )}

        {/* Loading State */}
        {loading && (
          <div className="mb-6 p-8 bg-gray-800 rounded-lg text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400 mx-auto mb-4"></div>
            <p className="text-gray-400">Carregando dados...</p>
          </div>
        )}

        {/* Date Filter */}
        <div className="mb-6 flex gap-2 flex-wrap">
          <button onClick={() => setDateRange('all')} className={`px-4 py-2 rounded-lg transition ${dateRange === 'all' ? 'bg-yellow-500 text-black' : 'bg-gray-700 hover:bg-gray-600'}`}>
            Todos
          </button>
          <button onClick={() => setDateRange('today')} className={`px-4 py-2 rounded-lg transition ${dateRange === 'today' ? 'bg-yellow-500 text-black' : 'bg-gray-700 hover:bg-gray-600'}`}>
            Hoje
          </button>
          <button onClick={() => setDateRange('week')} className={`px-4 py-2 rounded-lg transition ${dateRange === 'week' ? 'bg-yellow-500 text-black' : 'bg-gray-700 hover:bg-gray-600'}`}>
            7 dias
          </button>
          <button onClick={() => setDateRange('month')} className={`px-4 py-2 rounded-lg transition ${dateRange === 'month' ? 'bg-yellow-500 text-black' : 'bg-gray-700 hover:bg-gray-600'}`}>
            30 dias
          </button>
        </div>

        {!loading && data.length === 0 && (
          <div className="mb-6 p-8 bg-gray-800 rounded-lg text-center border border-gray-700">
            <Trophy className="mx-auto mb-4 text-gray-600" size={48} />
            <p className="text-gray-400">Nenhuma participa√ß√£o registrada ainda</p>
            <p className="text-sm text-gray-500 mt-2">Os dados aparecer√£o aqui ap√≥s os primeiros giros da roleta</p>
          </div>
        )}

        {!loading && data.length > 0 && (
          <>
            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
              <KPICard 
                icon={<Users />}
                title="Participantes"
                value={kpis.totalParticipants}
                subtitle="√∫nicos"
                color="blue"
              />
              <KPICard 
                icon={<Gift />}
                title="Pr√™mios"
                value={kpis.totalPrizes}
                subtitle="distribu√≠dos"
                color="yellow"
              />
              <KPICard 
                icon={<Phone />}
                title="Taxa WhatsApp"
                value={`${kpis.whatsappRate}%`}
                subtitle="convers√£o"
                color="green"
              />
              <KPICard 
                icon={<TrendingUp />}
                title="Pr√™mios 100%"
                value={kpis.fullPrizes}
                subtitle={`${kpis.fullPrizesPercent}% do total`}
                color="purple"
              />
            </div>

            {/* Charts Row 1 */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              {/* Prize Distribution */}
              <ChartCard title="Distribui√ß√£o de Pr√™mios">
                <ResponsiveContainer width="100%" height={300}>
                  <PieChart>
                    <Pie
                      data={kpis.prizeDistribution}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={renderCustomLabel}
                      outerRadius={100}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {kpis.prizeDistribution.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </ChartCard>

              {/* Prize Types Bar */}
              <ChartCard title="Pr√™mios por Tipo">
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={kpis.prizeTypes}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#444" />
                    <XAxis dataKey="name" stroke="#999" />
                    <YAxis stroke="#999" />
                    <Tooltip contentStyle={{ backgroundColor: '#333', border: 'none' }} />
                    <Bar dataKey="count" fill="#FFD700" />
                  </BarChart>
                </ResponsiveContainer>
              </ChartCard>
            </div>

            {/* Charts Row 2 */}
            <div className="grid grid-cols-1 gap-6 mb-6">
              {/* Timeline */}
              <ChartCard title="Participa√ß√µes ao Longo do Tempo">
                <ResponsiveContainer width="100%" height={300}>
                  <LineChart data={kpis.timeline}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#444" />
                    <XAxis dataKey="date" stroke="#999" />
                    <YAxis stroke="#999" />
                    <Tooltip contentStyle={{ backgroundColor: '#333', border: 'none' }} />
                    <Legend />
                    <Line type="monotone" dataKey="participantes" stroke="#FFD700" strokeWidth={2} />
                    <Line type="monotone" dataKey="premios100" stroke="#FF6B6B" strokeWidth={2} />
                  </LineChart>
                </ResponsiveContainer>
              </ChartCard>
            </div>

            {/* Recent Winners Table */}
            <ChartCard title="√öltimos Ganhadores">
              <div className="overflow-x-auto">
                <table className="w-full text-left">
                  <thead className="border-b border-gray-700">
                    <tr>
                      <th className="pb-3 text-yellow-400">Data/Hora</th>
                      <th className="pb-3 text-yellow-400">Telefone</th>
                      <th className="pb-3 text-yellow-400">Pr√™mio</th>
                      <th className="pb-3 text-yellow-400">WhatsApp</th>
                    </tr>
                  </thead>
                  <tbody>
                    {kpis.recentWinners.map((winner, idx) => (
                      <tr key={idx} className="border-b border-gray-800">
                        <td className="py-3 text-gray-300 text-sm">{formatDateTime(winner.datetime)}</td>
                        <td className="py-3 text-gray-300">{maskPhone(winner.phone)}</td>
                        <td className="py-3">
                          <span className={`px-2 py-1 rounded text-xs font-bold ${winner.prize.includes('100%') ? 'bg-purple-600' : 'bg-blue-600'}`}>
                            {winner.prize}
                          </span>
                        </td>
                        <td className="py-3">{winner.whatsapp ? '‚úÖ' : '‚è≥'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </ChartCard>
          </>
        )}

        {/* Footer Info */}
        <div className="mt-8 p-4 bg-gray-800 rounded-lg border border-gray-700">
          <h3 className="font-bold text-yellow-400 mb-2">üìä Instru√ß√µes de Configura√ß√£o:</h3>
          <ol className="text-sm text-gray-300 space-y-2 list-decimal list-inside">
            <li>Abra seu Google Sheets e v√° em <strong>Extensions ‚Üí Apps Script</strong></li>
            <li>Cole o c√≥digo do Apps Script (fornecido separadamente)</li>
            <li>Clique em <strong>Deploy ‚Üí New deployment</strong></li>
            <li>Escolha <strong>Web app</strong>, Execute as: <strong>Me</strong>, Who has access: <strong>Anyone</strong></li>
            <li>Copie a URL gerada e cole no c√≥digo deste dashboard (vari√°vel SCRIPT_URL)</li>
            <li>Clique em <strong>Atualizar</strong> para carregar os dados reais!</li>
          </ol>
          <p className="text-xs text-gray-500 mt-3">
            üí° Enquanto n√£o configurar, o dashboard mostra dados de exemplo para demonstra√ß√£o
          </p>
        </div>
      </div>
    </div>
  );
}

// Components
function KPICard({ icon, title, value, subtitle, color }) {
  const colors = {
    blue: 'from-blue-600 to-blue-800',
    yellow: 'from-yellow-600 to-yellow-800',
    green: 'from-green-600 to-green-800',
    purple: 'from-purple-600 to-purple-800'
  };

  return (
    <div className={`bg-gradient-to-br ${colors[color]} p-6 rounded-xl shadow-lg`}>
      <div className="flex items-start justify-between mb-3">
        <div className="text-white opacity-80">{icon}</div>
      </div>
      <div>
        <p className="text-gray-200 text-sm mb-1">{title}</p>
        <p className="text-3xl font-bold text-white mb-1">{value}</p>
        <p className="text-xs text-gray-200 opacity-75">{subtitle}</p>
      </div>
    </div>
  );
}

function ChartCard({ title, children }) {
  return (
    <div className="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
      <h3 className="text-xl font-bold text-yellow-400 mb-4">{title}</h3>
      {children}
    </div>
  );
}

// Helper functions
function formatDateTime(datetime) {
  if (!datetime) return '-';
  if (typeof datetime === 'string') {
    return datetime;
  }
  return new Date(datetime).toLocaleString('pt-BR');
}

function maskPhone(phone) {
  if (!phone) return '-';
  const str = phone.toString();
  if (str.length <= 4) return str;
  return str.slice(0, -4).replace(/./g, '*') + str.slice(-4);
}

function generateMockData() {
  const prizes = ['DESIGN 50%', 'FIO A FIO 50%', 'SHADOW L. 50%', 'DESIGN 100%', 'FIO A FIO 100%', 'SHADOW L. 100%'];
  const data = [];
  const now = new Date();
  
  for (let i = 0; i < 45; i++) {
    const date = new Date(now - (45 - i) * 24 * 60 * 60 * 1000);
    const count = Math.floor(Math.random() * 8) + 2;
    
    for (let j = 0; j < count; j++) {
      const prizeIndex = Math.floor(Math.random() * prizes.length);
      data.push({
        phone: `77${Math.floor(Math.random() * 900000000 + 100000000)}`,
        prize: prizes[prizeIndex],
        datetime: date.toLocaleString('pt-BR'),
        whatsapp: Math.random() > 0.3
      });
    }
  }
  
  return data;
}

function filterByDateRange(data, range) {
  if (range === 'all') return data;
  
  const now = new Date();
  const cutoff = new Date();
  
  if (range === 'today') {
    cutoff.setHours(0, 0, 0, 0);
  } else if (range === 'week') {
    cutoff.setDate(now.getDate() - 7);
  } else if (range === 'month') {
    cutoff.setDate(now.getDate() - 30);
  }
  
  return data.filter(d => {
    const itemDate = typeof d.datetime === 'string' 
      ? parseBRDate(d.datetime)
      : new Date(d.datetime);
    return itemDate >= cutoff;
  });
}

function parseBRDate(dateStr) {
  // Parse "DD/MM/YYYY HH:mm:ss" format
  const parts = dateStr.match(/(\d+)\/(\d+)\/(\d+)\s+(\d+):(\d+):(\d+)/);
  if (parts) {
    return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]);
  }
  return new Date(dateStr);
}

function calculateKPIs(data) {
  if (data.length === 0) {
    return {
      totalParticipants: 0,
      totalPrizes: 0,
      whatsappRate: 0,
      fullPrizes: 0,
      fullPrizesPercent: 0,
      prizeDistribution: [],
      prizeTypes: [],
      timeline: [],
      recentWinners: []
    };
  }

  const totalParticipants = new Set(data.map(d => d.phone)).size;
  const totalPrizes = data.length;
  const whatsappCount = data.filter(d => d.whatsapp).length;
  const whatsappRate = totalPrizes > 0 ? Math.round((whatsappCount / totalPrizes) * 100) : 0;
  const fullPrizes = data.filter(d => d.prize.includes('100%')).length;
  const fullPrizesPercent = totalPrizes > 0 ? Math.round((fullPrizes / totalPrizes) * 100) : 0;

  // Prize distribution
  const prizeCount = {};
  data.forEach(d => {
    prizeCount[d.prize] = (prizeCount[d.prize] || 0) + 1;
  });
  const prizeDistribution = Object.entries(prizeCount).map(([name, value]) => ({ name, value }));

  // Prize types
  const typeCount = { 'DESIGN': 0, 'FIO A FIO': 0, 'SHADOW L.': 0 };
  data.forEach(d => {
    if (d.prize.includes('DESIGN')) typeCount['DESIGN']++;
    else if (d.prize.includes('FIO A FIO')) typeCount['FIO A FIO']++;
    else if (d.prize.includes('SHADOW')) typeCount['SHADOW L.']++;
  });
  const prizeTypes = Object.entries(typeCount).map(([name, count]) => ({ name, count }));

  // Timeline
  const dateCount = {};
  const date100Count = {};
  data.forEach(d => {
    const dateStr = typeof d.datetime === 'string' 
      ? d.datetime.split(' ')[0]
      : new Date(d.datetime).toLocaleDateString('pt-BR');
    
    dateCount[dateStr] = (dateCount[dateStr] || 0) + 1;
    if (d.prize.includes('100%')) {
      date100Count[dateStr] = (date100Count[dateStr] || 0) + 1;
    }
  });
  const timeline = Object.keys(dateCount).sort((a, b) => {
    const dateA = parseBRDate(a + ' 00:00:00');
    const dateB = parseBRDate(b + ' 00:00:00');
    return dateA - dateB;
  }).map(date => ({
    date: date,
    participantes: dateCount[date],
    premios100: date100Count[date] || 0
  }));

  // Recent winners
  const recentWinners = data.slice(-10).reverse();

  return {
    totalParticipants,
    totalPrizes,
    whatsappRate,
    fullPrizes,
    fullPrizesPercent,
    prizeDistribution,
    prizeTypes,
    timeline,
    recentWinners
  };
}

const COLORS = ['#FFD700', '#FF6B6B', '#4ECDC4', '#95E1D3', '#F38181', '#AA96DA'];

const renderCustomLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent }) => {
  if (percent < 0.05) return null;
  const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
  const x = cx + radius * Math.cos(-midAngle * Math.PI / 180);
  const y = cy + radius * Math.sin(-midAngle * Math.PI / 180);

  return (
    <text x={x} y={y} fill="white" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" className="text-xs font-bold">
      {`${(percent * 100).toFixed(0)}%`}
    </text>
  );
};
